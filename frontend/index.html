<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"
      rel="stylesheet">
    <style>
      body {
        overflow: hidden;
        margin: 0;
      }

      .ui {
        position: absolute;
      }

      button{
        margin: 20px;
      }

      #overlay-left {
        background-color: #ff0000;
        width: 15%;
        height: 100%;
        position: absolute;
        top: 0;
        left: 0;
      }

      #overlay-right {
        background-color: #00ff00;
        width: 15%;
        height: 100%;
        position: absolute;
        top: 0;
        right: 0;
      }

      #overlay-bottom {
        background-color: #0000ff;
        width: 70%;
        height: 50px;
        position: absolute;
        bottom: 0;
        left: 15%;
      }

      #overlay-top {
        background-color: #4e4e4e;
        width: 70%;
        height: 5%;
        position: absolute;
        top: 0;
        left: 15%;
      }

      #play-button {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 46%;
        -ms-transform: translate(-48%, -50%);
        transform: translate(-48%, -50%);
      }
      
      #pause-button {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        -ms-transform: translate(-52%, -50%);
        transform: translate(-52%, -50%);
      }
      
      #reset-button {
        margin: 0;
        position: absolute;
        top: 50%;
        left: 54%;
        -ms-transform: translate(-52%, -50%);
        transform: translate(-52%, -50%);
      }
		</style>
    <title>FreeBots Robot Simulator</title>
</head>
<body>
  <script src="https://threejs.org/build/three.min.js"></script>
  <script src="https://threejs.org/examples/js/controls/OrbitControls.js"></script>

  <div style="width:100%;height:50px;text-align: center; color:white;" class="ui">Robot Simulator</div>
  <div id="overlay-left">

  </div>

  <div id="overlay-right">

  </div>

  <div id="overlay-bottom">

  </div>

  <div id="overlay-top">
    <button id="play-button" onclick="playSimulation()">
      <span class="material-icons">play_arrow</span>
    </button>
    <button id="pause-button" onclick="pauseSimulation()">
      <span class="material-icons">pause</span>
    </button>
    <button id="reset-button" onclick="resetSimulation()">
      <span class="material-icons">undo</span>
    </button>
  </div>
  <!--button style="bottom:60%; right:15%" id="front" class="ui">Front</-button>
  <button style="bottom:55%; right:20%" id="left" class="ui">Left</button>
  <button-- style="bottom:55%; right:10%" id="right" class="ui">Right</button-->
  <script>
    // Resize stuff
    var topDiv = document.getElementById('overlay-top');
    var topDivResizer = document.createElement('div');
    topDivResizer.className = 'resizer';
    topDivResizer.style.width = '100%';
    topDivResizer.style.height = '2%';
    topDivResizer.style.background = '#4e4e4e';
    topDivResizer.style.position = 'absolute';
    topDivResizer.style.right = 0;
    topDivResizer.style.bottom = 0;
    topDivResizer.style.cursor = 'se-resize';
    topDiv.appendChild(topDivResizer);
    topDivResizer.addEventListener('mousedown', initTopResize, false);

    function initTopResize(e) {
      window.addEventListener('mousemove', topResize, false);
      window.addEventListener('mouseup', stopTopResize, false);
    }
    function topResize(e) {
      topDiv.style.height = (e.clientY - topDiv.offsetTop) + 'px';
    }
    function stopTopResize(e) {
        window.removeEventListener('mousemove', topResize, false);
        window.removeEventListener('mouseup', stopTopResize, false);
    }
    
    var bottomDiv = document.getElementById('overlay-bottom');
    var bottomDivResizer = document.createElement('div');
    bottomDivResizer.className = 'resizer';
    bottomDivResizer.style.width = '100%';
    bottomDivResizer.style.height = '2%';
    bottomDivResizer.style.background = '#0000ff';
    bottomDivResizer.style.position = 'absolute';
    bottomDivResizer.style.right = 0;
    bottomDivResizer.style.top = 0;
    bottomDivResizer.style.cursor = 'se-resize';
    bottomDiv.appendChild(bottomDivResizer);
    bottomDivResizer.addEventListener('mousedown', initBottomResize, false);

    function initBottomResize(e) {
      window.addEventListener('mousemove', bottomResize, false);
      window.addEventListener('mouseup', stopBottomResize, false);
    }
    function bottomResize(e) {
      bottomDiv.style.height = (window.innerHeight - e.clientY) + 'px';
    }
    function stopBottomResize(e) {
        window.removeEventListener('mousemove', bottomResize, false);
        window.removeEventListener('mouseup', stopBottomResize, false);
    }

    var rightDiv = document.getElementById('overlay-right');
    var rightDivResizer = document.createElement('div');
    rightDivResizer.className = 'resizer';
    rightDivResizer.style.width = '2%';
    rightDivResizer.style.height = '100%';
    rightDivResizer.style.background = '#00ff00';
    rightDivResizer.style.position = 'absolute';
    rightDivResizer.style.left = 0;
    rightDivResizer.style.bottom = 0;
    rightDivResizer.style.cursor = 'se-resize';
    rightDiv.appendChild(rightDivResizer);
    rightDivResizer.addEventListener('mousedown', initRightResize, false);

    function initRightResize(e) {
      window.addEventListener('mousemove', rightResize, false);
      window.addEventListener('mouseup', stopRightResize, false);
    }
    function rightResize(e) {
      rightDiv.style.width = (window.innerWidth - e.clientX) + 'px';
    }
    function stopRightResize(e) {
        window.removeEventListener('mousemove', rightResize, false);
        window.removeEventListener('mouseup', stopRightResize, false);
    }

    var leftDiv = document.getElementById('overlay-left');
    var leftDivResizer = document.createElement('div');
    leftDivResizer.className = 'resizer';
    leftDivResizer.style.width = '2%';
    leftDivResizer.style.height = '100%';
    leftDivResizer.style.background = '#ff0000';
    leftDivResizer.style.position = 'absolute';
    leftDivResizer.style.right = 0;
    leftDivResizer.style.bottom = 0;
    leftDivResizer.style.cursor = 'se-resize';
    leftDiv.appendChild(leftDivResizer);
    leftDivResizer.addEventListener('mousedown', initLeftResize, false);

    function initLeftResize(e) {
      window.addEventListener('mousemove', leftResize, false);
      window.addEventListener('mouseup', stopLeftResize, false);
    }
    function leftResize(e) {
      leftDiv.style.width = (e.clientX - leftDiv.offsetLeft) + 'px';
    }
    function stopLeftResize(e) {
        window.removeEventListener('mousemove', leftResize, false);
        window.removeEventListener('mouseup', stopLeftResize, false);
    }

    // Three-js stuff
    var scene = new THREE.Scene();
    var camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);

    var renderer = new THREE.WebGLRenderer();
    
    renderer.setSize(window.innerWidth, window.innerHeight);
    document.body.appendChild(renderer.domElement);

    var controls = new THREE.OrbitControls(camera, renderer.domElement);

    var table_x_and_y = prompt("Specify the length of the table in X,Y format.");
    var table_pos = table_x_and_y.split(",");
    var table_x = table_pos[0];
    var table_y = table_pos[1];

    var robot_x_and_y = prompt("Where would you like to initialize the robot and where should it face? Please use the format X,Y,F where f is NORTH, EAST, SOUTH, or WEST.");
    var robot_pos = robot_x_and_y.split(",");
    var robot_x = robot_pos[0];
    var robot_y = robot_pos[1];
    var robot_f = robot_pos[2];
    
    var robot;

    var streamSocket

    function pauseSimulation() {
      streamSocket.send(JSON.stringify({type: "pause"}))
    }

    function resetSimulation() {
      streamSocket.send(JSON.stringify({type: "reset"}))
    }

    function playSimulation() {
      if (streamSocket == undefined) {
        streamSocket = new WebSocket("ws://localhost/api/stream-simulation");

        streamSocket.onmessage = function (event) {
          bot = JSON.parse(event.data)[0];
          console.log(bot)
          robot.position.x = bot.X;
          robot.position.y = bot.Y;
          robot.position.z = bot.Z;
        }
      } else {
        streamSocket.send(JSON.stringify({type: "play"}))
      }
    }

    async function initRobot(table_x, table_y, robot_x, robot_y, robot_f) {
      const data = {x: parseInt(table_x), y: parseInt(table_y)}

      var response = await fetch("http://localhost/api/set-position", {method: 'POST', body: JSON.stringify(data)});
      if (response.status = 200){
        response = await fetch("http://localhost/api/place-robot", {method: 'POST', body: JSON.stringify({x: parseInt(robot_x), y: parseInt(robot_y), f: robot_f})})
        return response;
      }
    }
    initRobot(table_x, table_y, robot_x, robot_y, robot_f).then(response => response.json()).then(data => {
      if (!data.f) {
        return;
      }
      var geometry = new THREE.BoxGeometry(table_x, table_y, 0.01);
      var material = new THREE.MeshBasicMaterial({
        color: "grey",
      });
      var floor = new THREE.Mesh(geometry, material);
      scene.add(floor);

      var robot_geometry = new THREE.BoxGeometry(1, 1, 1);
      var robot_material = new THREE.MeshBasicMaterial({
        color: "orange",
      });
      robot = new THREE.Mesh(robot_geometry, robot_material);
      scene.add(robot);

      camera.position.y = -5;
      camera.position.z = 2;
      camera.position.x = 0;
      camera.rotation.x = 1;
      robot.position.z = 1.00;
      robot.position.y = data.y;
      robot.position.x = data.x; 

      var animate = function() {
        requestAnimationFrame(animate);
        renderer.render(scene, camera);
      };

      animate();
    })
</script>
</body>
</html>